<!DOCTYPE html>
<html style="height: 100%">
    <head>
        <meta charset="utf-8">
        <title>How much is the Argentinian government lying about its exchange rate?</title>
    </head>
    <body style="height: 100%; margin: 0; padding: 10px">
        <div id="container" style="height: 100%"></div>

        <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/echarts@5.3.2/dist/echarts.min.js"></script>
<script type="text/javascript">
function intersect(a, b) {
  var setA = new Set(a);
  var setB = new Set(b);
  var intersection = new Set([...setA].filter(x => setB.has(x)));
  return Array.from(intersection);
}

function extractData(data, days) {
  let db = {};
  data.forEach(elem => db[elem['date']] = elem['value']);

  let ret = [];
  days.forEach(elem => {
    ret.push(db[elem]);
  });

  return ret;
}

var dom = document.getElementById("container");
var myChart = echarts.init(dom);

Promise.all([
  fetch("data/blue.json"),
  fetch("data/official.json"),
]).then(responses => Promise.all(responses.map(r => r.json())))
  .then(jsons => {
    const [blue, official] = jsons;

    let days = intersect(blue.map(o => o['date']), official.map(o => o['date']));
    days.sort();

    const dataBlue = extractData(blue, days);
    const dataOfficial = extractData(official, days);

    let dataLie = [];
    for (let i=0; i < days.length; ++i) {
      let pct = 100 * (dataBlue[i] / dataOfficial[i] - 1);
      dataLie.push(+pct.toFixed(2));
    }

    var option = {
      title: {
        text: document.title,
        left: 'center'
      },
      tooltip: {
        trigger: 'axis',
        axisPointer: {
          animation: false
        }
      },
      legend: {
        data: ['% Difference', 'Official Exchange Rate', 'Blue Dollar Rate'],
        selectedMode: false,
        top: 25,
        left: 10
      },
      toolbox: {
        top: 18,
        feature: {
          dataZoom: {
            yAxisIndex: 'none'
          },
          restore: {},
          saveAsImage: {}
        }
      },
      axisPointer: {
        link: [
          {
            xAxisIndex: 'all'
          }
        ]
      },
      dataZoom: [
        {
          type: 'slider',
          show: true,
          realtime: true,
          xAxisIndex: [0, 1],
          bottom: 30,
        },
        {
          type: 'inside',
          realtime: true,
          xAxisIndex: [0, 1],
        }
      ],
      grid: [
        {
          left: 60,
          right: 50,
          height: '40%'
        },
        {
          left: 60,
          right: 50,
          top: '50%',
          height: '40%'
        }
      ],
      xAxis: [
        {
          type: 'category',
          boundaryGap: false,
          axisLine: { onZero: true },
          axisLabel: { show: false, },
          data: days
        },
        {
          gridIndex: 1,
          type: 'category',
          boundaryGap: true,
          axisLine: { show: false },
          position: 'top',
          axisLabel: { show: true, },
          data: days,
        }
      ],
      yAxis: [
        {
          name: '% Difference Between Blue / Official',
          nameLocation: 'middle',
          nameGap: 45,
          axisLabel : {
            formatter: '{value}%'
          },
          min: -5,
          type: 'value'
        },
        {
          gridIndex: 1,
          name: 'Pesos Per Dollar',
          nameLocation: 'middle',
          nameGap: 45,
          type: 'log',
        }
      ],
      series: [
        {
          name: '% Difference',
          type: 'line',
          symbol: 'none',
          data: dataLie,
          color: '#843511',
        },
        {
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: [],
          markArea: {
            silent: true,
            label: { position: 'insideTop' },
            itemStyle: {
              color: '#3F93C1',
              opacity: 0.2,
            },
            label: {
              color: '#000',
              position: 'insideTop'
            },
            data: [
              [
                {
                  name: "Duhalde",
                  xAxis: days[0],
                },
                {
                  xAxis: '2003-05-26' // hack to make it work cuz there's no data for 2003-05-25
                },
              ]
            ]
          },
        },
        {
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: [],
          markArea: {
            silent: true,
            itemStyle: {
              color: '#3F93C1',
              opacity: 0.3,
            },
            label: {
              color: '#000',
              position: 'insideTop'
            },
            data: [
              [
                {
                  name: "Néstor Kirchner",
                  xAxis: '2003-05-26' // hack to make it work cuz there's no data for 2003-05-25
                },
                {
                  xAxis: '2007-12-10'
                },
              ]
            ]
          },
        },
        {
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: [],
          markArea: {
            silent: true,
            itemStyle: {
              color: '#3F93C1',
              opacity: 0.2,
            },
            label: {
              color: '#000',
              position: 'insideTop'
            },
            data: [
              [
                {
                  name: "Cristina Kirchner",
                  xAxis: '2007-12-10'
                },
                {
                  xAxis: '2015-12-10'
                },
              ]
            ]
          },
        },
        {
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: [],
          markArea: {
            silent: true,
            itemStyle: {
              color: '#F7D84C',
              opacity: 0.2,
            },
            label: {
              color: '#000',
              position: 'insideTop'
            },
            data: [
              [
                {
                  name: "Macri",
                  xAxis: '2015-12-10'
                },
                {
                  xAxis: '2019-12-10'
                },
              ]
            ]
          },
        },
        {
          type: 'line',
          xAxisIndex: 0,
          yAxisIndex: 0,
          data: [],
          markArea: {
            silent: true,
            itemStyle: {
              color: '#3F93C1',
              opacity: 0.2,
            },
            label: {
              color: '#000',
              position: 'insideTop'
            },
            data: [
              [
                {
                  name: "Fernández",
                  xAxis: '2019-12-10'
                },
                {
                  xAxis: days[days.length - 1],
                },
              ]
            ]
          },
        },
        {
          name: 'Official Exchange Rate',
          type: 'line',
          xAxisIndex: 1,
          yAxisIndex: 1,
          symbol: 'none',
          data: dataOfficial,
          color: '#FCBF49'
        },
        {
          name: 'Blue Dollar Rate',
          type: 'line',
          xAxisIndex: 1,
          yAxisIndex: 1,
          symbol: 'none',
          data: dataBlue,
          color: '#75AADB'
        }
      ]
    };

    myChart.setOption(option);
    window.onresize = function() {
      myChart.resize();
    };

  });
</script>
    </body>
</html>

